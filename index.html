<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>汉语词汇闪卡学习器</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 设置默认字体为无衬线字体，并使用 Inter 字体 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Microsoft YaHei', 'SimHei', sans-serif;
            background-color: #fffbe6; /* 奶油黄背景 - 活泼可爱 */
            color: #1e3a8a; /* 深蓝色文字 */
        }
        /* 闪卡容器样式，用于 3D 翻转效果 */
        .card-container {
            perspective: 1000px;
            width: 100%;
            height: 100%;
            max-width: 480px;
            max-height: 400px;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            position: relative;
            border-radius: 2rem; /* 更大的圆角 */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 10px 20px -5px rgba(0, 0, 0, 0.1); /* 柔和且明显的阴影 */
        }
        .flashcard.flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2.5rem;
            border-radius: 2rem;
        }
        /* 卡片正面：天空蓝 */
        #cardFront {
            background-color: #bae6fd; 
            color: #1e3a8a; /* 深蓝文字 */
        }
        /* 卡片背面：活泼橙色 */
        .card-back {
            transform: rotateY(180deg);
            background-color: #fcd34d; 
            color: #1e3a8a; /* 深蓝文字 */
        }
        .speaker-icon {
            cursor: pointer;
            transition: transform 0.2s, fill 0.2s;
            fill: #ec4899; /* 扬声器图标：鲜艳粉色 */
        }
        .speaker-icon:hover {
            transform: scale(1.1);
            fill: #f97316; /* 悬停时变为橙色 */
        }
        /* 汉字 SVG 颜色继承卡片颜色 */
        #wordSvg {
            fill: #1e3a8a; 
        }
        .loading-ring {
            border: 4px solid rgba(30, 58, 138, 0.3); /* 深蓝半透明 */
            border-top: 4px solid #1e3a8a; /* 深蓝 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- 闪卡应用主体容器 -->
    <div id="app" class="flex flex-col items-center w-full max-w-xl">
        <h1 class="text-3xl font-extrabold mb-6 flex items-center" style="color: #ef4444;">
            <!-- 标题 SVG 装饰：使用红色 -->
            <svg class="w-8 h-8 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="color: #f97316;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.468 9.242 5.23 7.65 5.036c-1.397-.174-2.75-.02-4.06.311v11.731c1.31-.331 2.663-.485 4.06-.311C9.242 18.57 10.832 18.332 12 17.547m0-13c1.168.785 2.758 1.023 4.35 1.217 1.397.174 2.75.02 4.06-.311v11.731c-1.31-.331-2.663-.485-4.06-.311C14.758 18.57 13.168 18.332 12 17.547"></path></svg>
            YCT 1 汉语词汇学习
        </h1>

        <!-- 闪卡展示区域 -->
        <div class="card-container w-full h-[400px] mb-8">
            <div id="flashcard" class="flashcard">
                <!-- 闪卡正面 (只显示汉字) -->
                <div id="cardFront" class="card-face">
                    <div id="loadingIndicator" class="hidden flex flex-col items-center justify-center">
                        <div class="loading-ring mb-4"></div>
                        <p class="text-white text-lg" style="color: #1e3a8a;">正在加载音频...</p>
                    </div>
                    <div id="cardContent" class="flex flex-col items-center justify-center w-full h-full text-center">
                        <p id="cardCategory" class="text-lg mb-4 font-semibold" style="color: #f97316;"></p>
                        <!-- 使用 SVG 绘制词汇，以满足可视化要求 -->
                        <svg id="wordSvg" viewBox="0 0 450 150" class="w-full max-w-xs h-auto" fill="currentColor">
                            <!-- 仅显示汉字 -->
                            <text id="wordText" x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="70" font-weight="bold" fill="currentColor">词汇</text>
                        </svg>
                        
                        <!-- SVG 扬声器图标 (鲜艳粉色) -->
                        <svg onclick="speakCurrentWord()" class="speaker-icon w-10 h-10 mt-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 4h-2.586l-2.707-2.707A1 1 0 009.293 1H6a1 1 0 00-1 1v2.586L2.707 7.707A1 1 0 002 8.414V19a3 3 0 003 3h14a3 3 0 003-3V5a1 1 0 00-1-1h-4zm-4 13.414L7.586 13H5v-4h2.586L12 4.586V17.414zM16 11H13V9h3v2z"></path>
                        </svg>
                        <p class="text-sm mt-4" style="color: #4b5563;">点击翻转卡片查看拼音和翻译</p>
                    </div>
                </div>

                <!-- 闪卡背面 (显示拼音和翻译) -->
                <div id="cardBack" class="card-face card-back">
                    <p class="text-xl mb-6 font-semibold" style="color: #1e3a8a;">拼音与乌兹别克语翻译</p>
                    <p id="pinyinTextBack" class="text-4xl font-bold mb-4" style="color: #1e3a8a;"></p>
                    <hr class="w-2/3 border-t mb-4" style="border-color: #ef4444;">
                    <p id="translationText" class="text-2xl" style="color: #374151;"></p>
                    <p class="text-sm mt-8" style="color: #4b5563;">点击再次翻转</p>
                </div>
            </div>
        </div>

        <!-- 控制按钮 -->
        <div class="flex justify-between w-full max-w-md space-x-4">
            <!-- 上一个按钮：柔和绿色 -->
            <button onclick="prevCard()" class="flex items-center justify-center px-4 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-2xl transition duration-300 shadow-xl shadow-green-400/50 w-1/2">
                <!-- SVG 向左箭头 -->
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                上一个
            </button>
            <!-- 下一个按钮：充满活力的红色 -->
            <button onclick="nextCard()" class="flex items-center justify-center px-4 py-3 bg-red-500 hover:bg-red-600 text-white font-bold rounded-2xl transition duration-300 shadow-xl shadow-red-400/50 w-1/2">
                下一个
                <!-- SVG 向右箭头 -->
                <svg class="w-6 h-6 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
            </button>
        </div>

        <!-- 翻转卡片按钮：亮紫色 -->
        <button onclick="flipCard()" class="mt-6 px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white font-bold rounded-2xl transition duration-300 shadow-xl shadow-purple-400/50">
            翻转卡片
        </button>
    </div>

    <script>
        // 全局变量定义
        const apiKey = ""; // API 密钥（在 Canvas 环境中由运行时提供）
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
        let currentCardIndex = 0;
        let isFlipped = false;
        let audioContext;
        let audioPlayer = null;

        // 界面元素引用
        const flashcard = document.getElementById('flashcard');
        const wordText = document.getElementById('wordText');
        const pinyinTextBack = document.getElementById('pinyinTextBack'); // 背面拼音
        const translationText = document.getElementById('translationText');
        const cardCategory = document.getElementById('cardCategory');
        const cardContent = document.getElementById('cardContent');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // 词汇数据（根据用户提供的图片整理）
        const vocabList = [
            { cn: "家", py: "jiā", uz: "uy", category: "名词 (Míngcí)" },
            { cn: "学校", py: "xuéxiào", uz: "maktab", category: "名词" },
            { cn: "商店", py: "shāngdiàn", uz: "do'kon", category: "名词" },
            { cn: "中国人", py: "Zhōngguórén", uz: "Xitoylik", category: "名词" },
            { cn: "爸爸", py: "bàba", uz: "ota; dada", category: "名词" },
            { cn: "妈妈", py: "māma", uz: "ona; oyi", category: "名词" },
            { cn: "哥哥", py: "gēge", uz: "katta aka", category: "名词" },
            { cn: "姐姐", py: "jiějie", uz: "katta opa", category: "名词" },
            { cn: "老师", py: "lǎoshī", uz: "ustoz", category: "名词" },
            { cn: "手", py: "shǒu", uz: "qo'l", category: "名词" },
            { cn: "口", py: "kǒu", uz: "og'iz", category: "名词" },
            { cn: "眼睛", py: "yǎnjīng", uz: "ko'z", category: "名词" },
            { cn: "头发", py: "tóufa", uz: "soch", category: "名词" },
            { cn: "耳朵", py: "ěrduo", uz: "quloq", category: "名词" },
            { cn: "鼻子", py: "bízi", uz: "burun", category: "名词" },
            { cn: "个子", py: "gèzi", uz: "bo'y", category: "名词" },
            { cn: "猫", py: "māo", uz: "mushuk", category: "名词" },
            { cn: "狗", py: "gǒu", uz: "it; kuchuk", category: "名词" },
            { cn: "鸟", py: "niǎo", uz: "qo'sh", category: "名词" },
            { cn: "鱼", py: "yú", uz: "baliq", category: "名词" },
            { cn: "水", py: "shuǐ", uz: "suv", category: "名词" },
            { cn: "牛奶", py: "niúnǎi", uz: "sut", category: "名词" },
            { cn: "米饭", py: "mǐfàn", uz: "guruch", category: "名词" },
            { cn: "面条", py: "miàntiáo", uz: "lag'mon", category: "名词" },
            { cn: "苹果", py: "píngguǒ", uz: "olma", category: "名词" },
            { cn: "今天", py: "jīntiān", uz: "bugun", category: "名词" },
            { cn: "明天", py: "míngtiān", uz: "ertaga", category: "名词" },
            { cn: "现在", py: "xiànzài", uz: "hozir", category: "名词" },
            { cn: "月", py: "yuè", uz: "oy", category: "名词" },
            { cn: "号", py: "hào", uz: "kun", category: "名词" },
            { cn: "星期", py: "xīngqī", uz: "hafta", category: "名词" },
            { cn: "点", py: "diǎn", uz: "soat", category: "名词" },
            { cn: "谢谢", py: "xièxie", uz: "rahmat", category: "动词 (Dòngcí)" },
            { cn: "再见", py: "zàijiàn", uz: "hayr; ko'rishguncha", category: "动词" },
            { cn: "是", py: "shì", uz: "bo'lmoq", category: "动词" },
            { cn: "有", py: "yǒu", uz: "bor", category: "动词" },
            { cn: "看", py: "kàn", uz: "ko'rmoq", category: "动词" },
            { cn: "吃", py: "chī", uz: "yemoq", category: "动词" },
            { cn: "喝", py: "hē", uz: "ichmoq", category: "动词" },
            { cn: "去", py: "qù", uz: "bormoq", category: "动词" },
            { cn: "叫", py: "jiào", uz: "chaqirmoq", category: "动词" },
            { cn: "爱", py: "ài", uz: "sevmoq", category: "动词" },
            { cn: "喜欢", py: "xǐhuan", uz: "yoqtirmoq", category: "动词" },
            { cn: "认识", py: "rènshi", uz: "tanishish", category: "动词" },
            { cn: "好", py: "hǎo", uz: "yaxshi", category: "形容词 (Xíngróngcí)" },
            { cn: "多", py: "duō", uz: "ko'p", category: "形容词" },
            { cn: "大", py: "dà", uz: "katta", category: "形容词" },
            { cn: "小", py: "xiǎo", uz: "kichkina", category: "形容词" },
            { cn: "长", py: "cháng", uz: "uzun", category: "形容词" },
            { cn: "高", py: "gāo", uz: "baland", category: "形容词" },
            { cn: "高兴", py: "gāoxìng", uz: "xursand", category: "形容词" },
            { cn: "我", py: "wǒ", uz: "men", category: "代词 (Dàicí)" },
            { cn: "你", py: "nǐ", uz: "sen", category: "代词" },
            { cn: "他", py: "tā", uz: "u (o'g'il bola)", category: "代词" },
            { cn: "她", py: "tā", uz: "u (qiz bola)", category: "代词" },
            { cn: "我们", py: "wǒmen", uz: "biz", category: "代词" },
            { cn: "这(这儿)", py: "zhè(zhèr)", uz: "bu yerda", category: "代词" },
            { cn: "那(那儿)", py: "nà(nàr)", uz: "u yerda", category: "代词" },
            { cn: "哪(哪儿)", py: "nǎ(nǎr)", uz: "qayerda", category: "代词" },
            { cn: "谁", py: "shéi", uz: "kim", category: "代词" },
            { cn: "什么", py: "shénme", uz: "nima", category: "代词" },
            { cn: "几", py: "jǐ", uz: "ko'p", category: "代词" },
            { cn: "一", py: "yī", uz: "bir", category: "数词 (Shùcí)" },
            { cn: "二", py: "èr", uz: "ikki", category: "数词" },
            { cn: "三", py: "sān", uz: "uch", category: "数词" },
            { cn: "四", py: "sì", uz: "to'rt", category: "数词" },
            { cn: "五", py: "wǔ", uz: "besh", category: "数词" },
            { cn: "六", py: "liù", uz: "olti", category: "数词" },
            { cn: "七", py: "qī", uz: "yetti", category: "数词" },
            { cn: "八", py: "bā", uz: "sakkiz", category: "数词" },
            { cn: "九", py: "jiǔ", uz: "to'qqiz", category: "数词" },
            { cn: "十", py: "shí", uz: "o'n", category: "数词" },
            { cn: "个", py: "gè", uz: "hisob so'z = ta (words of their own)", category: "量词 (Liàngcí)" },
            { cn: "岁", py: "suì", uz: "-da (yoshi uchun)", category: "量词" },
            { cn: "不", py: "bù", uz: "yo'q", category: "副词 (Fùcí)" },
            { cn: "很", py: "hěn", uz: "juda", category: "副词" },
            { cn: "和", py: "hé", uz: "va", category: "连词 (Liáncí)" },
            { cn: "在", py: "zài", uz: "-da", category: "介词 (Jiècí)" },
            { cn: "的", py: "de", uz: "-ning", category: "助词 (Zhùcí)" },
            { cn: "吗", py: "ma", uz: "-mi", category: "助词" },
        ];

        // --- TTS 音频处理工具函数 ---

        /**
         * 将 Base64 字符串转换为 ArrayBuffer。
         * @param {string} base64 - Base64 编码的字符串。
         * @returns {ArrayBuffer} 对应的 ArrayBuffer。
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * 将 PCM 16 位音频数据转换为 WAV 文件格式的 Blob。
         * @param {Int16Array} pcmData - 16 位 PCM 签名整数数组。
         * @param {number} sampleRate - 采样率。
         * @returns {Blob} WAV 格式的 Blob 对象。
         */
        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bitDepth = 16;
            const byteRate = sampleRate * numChannels * (bitDepth / 8);
            const blockAlign = numChannels * (bitDepth / 8);
            const dataSize = pcmData.length * (bitDepth / 8);

            // WAV 文件头部大小 (44 字节)
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            let offset = 0;

            // 写入 RIFF 块
            writeString(view, offset, 'RIFF'); offset += 4;
            view.setUint32(offset, 36 + dataSize, true); offset += 4;
            writeString(view, offset, 'WAVE'); offset += 4;

            // 写入 fmt 块
            writeString(view, offset, 'fmt '); offset += 4;
            view.setUint32(offset, 16, true); offset += 4;       // Subchunk1Size (16 for PCM)
            view.setUint16(offset, 1, true); offset += 2;        // AudioFormat (1 for PCM)
            view.setUint16(offset, numChannels, true); offset += 2; // NumChannels
            view.setUint32(offset, sampleRate, true); offset += 4; // SampleRate
            view.setUint32(offset, byteRate, true); offset += 4;  // ByteRate
            view.setUint16(offset, blockAlign, true); offset += 2;  // BlockAlign
            view.setUint16(offset, bitDepth, true); offset += 2;    // BitsPerSample

            // 写入 data 块
            writeString(view, offset, 'data'); offset += 4;
            view.setUint32(offset, dataSize, true); offset += 4;

            // 写入 PCM 数据
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(offset, pcmData[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        /**
         * 辅助函数：向 DataView 写入字符串。
         */
        function writeString(view, offset, s) {
            for (let i = 0; i < s.length; i++) {
                view.setUint8(offset + i, s.charCodeAt(i));
            }
        }

        // --- 核心应用逻辑 ---

        /**
         * 初始化音频上下文。
         */
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        /**
         * 播放当前词汇的 TTS 音频。
         */
        async function speakCurrentWord() {
            const currentWord = vocabList[currentCardIndex].cn;
            await speakWord(currentWord);
        }

        /**
         * 调用 Gemini TTS API 并播放音频。
         * @param {string} word - 要朗读的中文词汇。
         */
        async function speakWord(word) {
            // 如果已经在播放，则停止并退出
            if (audioPlayer && audioPlayer.state === 'running') {
                audioPlayer.stop();
                audioPlayer = null;
                return;
            }

            // 显示加载指示器并隐藏卡片内容
            cardContent.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');

            // 确保音频上下文已初始化
            initAudioContext();

            const payload = {
                contents: [{
                    parts: [{ text: `说: ${word}` }] // 指示模型朗读该词
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" } // 使用 Kore 声音
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            let audioUrl = null;
            const maxRetries = 3;
            let delay = 1000;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(TTS_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP 错误！状态码: ${response.status}`);
                    }

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                        // 从 mimeType 字符串中提取采样率，例如 "audio/L16;rate=24000"
                        const rateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000; // 默认 24000

                        const pcmData = base64ToArrayBuffer(audioData);
                        // API 返回的是 16 位 PCM 签名整数数据
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        audioUrl = URL.createObjectURL(wavBlob);
                        
                        // 使用 Web Audio API 播放
                        const arrayBuffer = await wavBlob.arrayBuffer();
                        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                        
                        // **********************************************
                        // 修复：确保 AudioContext 处于运行状态以进行播放
                        if (audioContext.state === 'suspended') {
                            await audioContext.resume();
                        }
                        // **********************************************

                        audioPlayer = audioContext.createBufferSource();
                        audioPlayer.buffer = audioBuffer;
                        audioPlayer.connect(audioContext.destination);
                        
                        audioPlayer.start(0);

                        // 播放结束后清理
                        audioPlayer.onended = () => {
                            audioPlayer = null;
                            if (audioUrl) {
                                URL.revokeObjectURL(audioUrl);
                            }
                        };
                        
                        // 成功播放，跳出重试循环
                        break; 

                    } else {
                        throw new Error("API 响应中缺少音频数据或 MIME 类型不正确。");
                    }
                } catch (error) {
                    console.error(`尝试 ${attempt + 1} 失败:`, error.message);
                    if (attempt < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // 指数退避
                    } else {
                        // 使用自定义模态框替代 alert()
                        // 示例：displayAlert("音频播放失败。请检查网络连接或稍后再试。");
                        console.error("音频播放失败。请检查网络连接或稍后再试。");
                    }
                }
            }
            
            // 隐藏加载指示器并重新显示卡片内容
            loadingIndicator.classList.add('hidden');
            cardContent.classList.remove('hidden');
        }


        /**
         * 更新闪卡的内容。
         */
        function updateCard() {
            const card = vocabList[currentCardIndex];
            
            // 正面内容 (中文/类别)
            cardCategory.textContent = card.category;
            wordText.textContent = card.cn;
            
            // 背面内容 (拼音/翻译)
            pinyinTextBack.textContent = card.py; // 拼音移到背面
            translationText.textContent = card.uz;
            
            // 确保卡片正面显示
            isFlipped = false;
            flashcard.classList.remove('flipped');
        }

        /**
         * 翻转卡片。
         */
        function flipCard() {
            isFlipped = !isFlipped;
            if (isFlipped) {
                flashcard.classList.add('flipped');
            } else {
                flashcard.classList.remove('flipped');
            }
        }

        /**
         * 切换到下一个词汇。
         */
        function nextCard() {
            currentCardIndex = (currentCardIndex + 1) % vocabList.length;
            updateCard();
        }

        /**
         * 切换到上一个词汇。
         */
        function prevCard() {
            currentCardIndex = (currentCardIndex - 1 + vocabList.length) % vocabList.length;
            updateCard();
        }

        /**
         * 初始化应用。
         */
        window.onload = function() {
            // 首次加载时更新卡片内容
            updateCard();

            // 为闪卡添加点击翻转事件监听器
            flashcard.addEventListener('click', flipCard);

            // 尝试初始化 AudioContext
            try {
                initAudioContext();
            } catch (e) {
                console.warn("无法初始化 AudioContext。浏览器可能不支持或需要用户交互。");
            }
        };

    </script>
</body>
</html>