<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YCT 1 Yangi so'zlar</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 设置默认字体为无衬线字体，并使用 Inter 字体 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Microsoft YaHei', 'SimHei', sans-serif;
            background-color: #fffbe6; /* 奶油黄背景 - 活泼可爱 */
            color: #1e3a8a; /* 深蓝色文字 */
            padding-top: 1rem; /* 移除冗余的顶部填充，只保留页边距 */
        }
        /* 闪卡容器样式，用于 3D 翻转效果 */
        
        /* 新增：用于强制卡片为正方形的容器 */
        .card-square-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 100%; /* 强制 1:1 比例 */
        }

        .flashcard {
            /* 必须是绝对定位，以适配正方形容器 */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            
            transition: transform 0.6s;
            transform-style: preserve-3d;
            border-radius: 1rem; /* 适合网格的圆角 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* 柔和阴影 */
        }
        .flashcard.flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            border-radius: 1rem;
            text-align: center;
        }
        /* 卡片正面：天空蓝 */
        .card-front-style {
            background-color: #bae6fd; 
            color: #1e3a8a; /* 深蓝文字 */
        }
        /* 卡片背面：活泼橙色 */
        .card-back-style {
            transform: rotateY(180deg);
            background-color: #fcd34d; 
            color: #1e3a8a; /* 深蓝文字 */
        }
        .speaker-icon {
            cursor: pointer;
            transition: transform 0.2s, fill 0.2s;
            fill: #ec4899; /* 扬声器图标：鲜艳粉色 */
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            z-index: 10;
        }
        .speaker-icon:hover {
            transform: scale(1.1);
            fill: #f97316; /* 悬停时变为橙色 */
        }
        /* 汉字 SVG 颜色继承卡片颜色 */
        .word-svg {
            fill: #1e3a8a; 
        }
        .loading-ring {
            border: 4px solid rgba(30, 58, 138, 0.3);
            border-top: 4px solid #1e3a8a;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 新标题样式 */
        .main-title-container {
            /* 移除固定定位，让它在正常文档流中 */
            position: static;
            
            background-color: transparent; /* 透明背景 */
            padding: 0.75rem 1rem; /* 变窄 */
            border-bottom-left-radius: 1rem;
            border-bottom-right-radius: 1rem;
            width: 100%;
            text-align: center;
            margin-bottom: 1rem; /* 增加标题和卡片网格的间距 */
        }
        .main-title {
            color: #ef4444; /* 红色文字突出 */
            font-size: 1.5rem; /* 略微缩小以配合窄栏 */
            font-weight: 900;
            line-height: 1.2;
        }
        .subtitle-text {
            color: #ef4444; /* 红色小字突出 */
            font-size: 0.9rem;
            margin-top: 0.25rem; /* 缩小间距 */
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- 闪卡应用主体容器 -->
    <div id="app" class="flex flex-col items-center w-full max-w-4xl">
        
        <!-- 样式修改后的标题区域 (现在处于正常文档流中) -->
        <div class="main-title-container">
            <h1 class="main-title">
                YCT 1 Yangi so'zlar
            </h1>
            <p class="subtitle-text">Dilfuza Kāng lǎo shī bilan xitoy tilini o'rganmiz</p>
            <!-- 标题 SVG 装饰图标已删除 -->
        </div>


        <!-- 词汇网格展示区域 -->
        <!-- sm: 2列, md: 3列, lg: 4列 -->
        <div id="vocabGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 w-full">
            <!-- 闪卡将由 JavaScript 渲染到这里 -->
        </div>

        <!-- 翻转卡片按钮 (保持独立翻转功能) -->
        <button onclick="flipAllCards()" class="mt-8 px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white font-bold rounded-2xl transition duration-300 shadow-xl shadow-purple-400/50">
            Hamma Kartalarni Ag'darish
        </button>
        <p class="text-sm mt-4" style="color: #4b5563;">（点击任一卡片可单独翻转）</p>

    </div>

    <script>
        // 全局变量定义
        const apiKey = ""; // API 密钥（在 Canvas 环境中由运行时提供）
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
        let audioContext;
        let audioPlayer = null;

        // 词汇数据 (省略, 因为它们没有变化)
        const vocabList = [
            { cn: "家", py: "jiā", uz: "uy", category: "名词 (Míngcí)" },
            { cn: "学校", py: "xuéxiào", uz: "maktab", category: "名词" },
            { cn: "商店", py: "shāngdiàn", uz: "do'kon", category: "名词" },
            { cn: "中国人", py: "Zhōngguórén", uz: "Xitoylik", category: "名词" },
            { cn: "爸爸", py: "bàba", uz: "ota; dada", category: "名词" },
            { cn: "妈妈", py: "māma", uz: "ona; oyi", category: "名词" },
            { cn: "哥哥", py: "gēge", uz: "katta aka", category: "名词" },
            { cn: "姐姐", py: "jiějie", uz: "katta opa", category: "名词" },
            { cn: "老师", py: "lǎoshī", uz: "ustoz", category: "名词" },
            { cn: "手", py: "shǒu", uz: "qo'l", category: "名词" },
            { cn: "口", py: "kǒu", uz: "og'iz", category: "名词" },
            { cn: "眼睛", py: "yǎnjīng", uz: "ko'z", category: "名词" },
            { cn: "头发", py: "tóufa", uz: "soch", category: "名词" },
            { cn: "耳朵", py: "ěrduo", uz: "quloq", category: "名词" },
            { cn: "鼻子", py: "bízi", uz: "burun", category: "名词" },
            { cn: "个子", py: "gèzi", uz: "bo'y", category: "名词" },
            { cn: "猫", py: "māo", uz: "mushuk", category: "名词" },
            { cn: "狗", py: "gǒu", uz: "it; kuchuk", category: "名词" },
            { cn: "鸟", py: "niǎo", uz: "qo'sh", category: "名词" },
            { cn: "鱼", py: "yú", uz: "baliq", category: "名词" },
            { cn: "水", py: "shuǐ", uz: "suv", category: "名词" },
            { cn: "牛奶", py: "niúnǎi", uz: "sut", category: "名词" },
            { cn: "米饭", py: "mǐfàn", uz: "guruch", category: "名词" },
            { cn: "面条", py: "miàntiáo", uz: "lag'mon", category: "名词" },
            { cn: "苹果", py: "píngguǒ", uz: "olma", category: "名词" },
            { cn: "今天", py: "jīntiān", uz: "bugun", category: "名词" },
            { cn: "明天", py: "míngtiān", uz: "ertaga", category: "名词" },
            { cn: "现在", py: "xiànzài", uz: "hozir", category: "名词" },
            { cn: "月", py: "yuè", uz: "oy", category: "名词" },
            { cn: "号", py: "hào", uz: "kun", category: "名词" },
            { cn: "星期", py: "xīngqī", uz: "hafta", category: "名词" },
            { cn: "点", py: "diǎn", uz: "soat", category: "名词" },
            { cn: "谢谢", py: "xièxie", uz: "rahmat", category: "动词 (Dòngcí)" },
            { cn: "再见", py: "zàijiàn", uz: "hayr; ko'rishguncha", category: "动词" },
            { cn: "是", py: "shì", uz: "bo'lmoq", category: "动词" },
            { cn: "有", py: "yǒu", uz: "bor", category: "动词" },
            { cn: "看", py: "kàn", uz: "ko'rmoq", category: "动词" },
            { cn: "吃", py: "chī", uz: "yemoq", category: "动词" },
            { cn: "喝", py: "hē", uz: "ichmoq", category: "动词" },
            { cn: "去", py: "qù", uz: "bormoq", category: "动词" },
            { cn: "叫", py: "jiào", uz: "chaqirmoq", category: "动词" },
            { cn: "爱", py: "ài", uz: "sevmoq", category: "动词" },
            { cn: "喜欢", py: "xǐhuan", uz: "yoqtirmoq", category: "动词" },
            { cn: "认识", py: "rènshi", uz: "tanishish", category: "动词" },
            { cn: "好", py: "hǎo", uz: "yaxshi", category: "形容词 (Xíngróngcí)" },
            { cn: "多", py: "duō", uz: "ko'p", category: "形容词" },
            { cn: "大", py: "dà", uz: "katta", category: "形容词" },
            { cn: "小", py: "xiǎo", uz: "kichkina", category: "形容词" },
            { cn: "长", py: "cháng", uz: "uzun", category: "形容词" },
            { cn: "高", py: "gāo", uz: "baland", category: "形容词" },
            { cn: "高兴", py: "gāoxìng", uz: "xursand", category: "形容词" },
            { cn: "我", py: "wǒ", uz: "men", category: "代词 (Dàicí)" },
            { cn: "你", py: "nǐ", uz: "sen", category: "代词" },
            { cn: "他", py: "tā", uz: "u (o'g'il bola)", category: "代词" },
            { cn: "她", py: "tā", uz: "u (qiz bola)", category: "代词" },
            { cn: "我们", py: "wǒmen", uz: "biz", category: "代词" },
            { cn: "这(这儿)", py: "zhè(zhèr)", uz: "bu yerda", category: "代词" },
            { cn: "那(那儿)", py: "nà(nàr)", uz: "u yerda", category: "代词" },
            { cn: "哪(哪儿)", py: "nǎ(nǎr)", uz: "qayerda", category: "代词" },
            { cn: "谁", py: "shéi", uz: "kim", category: "代词" },
            { cn: "什么", py: "shénme", uz: "nima", category: "代词" },
            { cn: "几", py: "jǐ", uz: "ko'p", category: "代词" },
            { cn: "一", py: "yī", uz: "bir", category: "数词 (Shùcí)" },
            { cn: "二", py: "èr", uz: "ikki", category: "数词" },
            { cn: "三", py: "sān", uz: "uch", category: "数词" },
            { cn: "四", py: "sì", uz: "to'rt", category: "数词" },
            { cn: "五", py: "wǔ", uz: "besh", category: "数词" },
            { cn: "六", py: "liù", uz: "olti", category: "数词" },
            { cn: "七", py: "qī", uz: "yetti", category: "数词" },
            { cn: "八", py: "bā", uz: "sakkiz", category: "数词" },
            { cn: "九", py: "jiǔ", uz: "to'qqiz", category: "数词" },
            { cn: "十", py: "shí", uz: "o'n", category: "数词" },
            { cn: "个", py: "gè", uz: "hisob so'z = ta (words of their own)", category: "量词 (Liàngcí)" },
            { cn: "岁", py: "suì", uz: "-da (yoshi uchun)", category: "量词" },
            { cn: "不", py: "bù", uz: "yo'q", category: "副词 (Fùcí)" },
            { cn: "很", py: "hěn", uz: "juda", category: "副词" },
            { cn: "和", py: "hé", uz: "va", category: "连词 (Liáncí)" },
            { cn: "在", py: "zài", uz: "-da", category: "介词 (Jiècí)" },
            { cn: "的", py: "de", uz: "-ning", category: "助词 (Zhùcí)" },
            { cn: "吗", py: "ma", uz: "-mi", category: "助词" },
        ];

        // --- TTS 音频处理工具函数 (无变化) ---
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bitDepth = 16;
            const byteRate = sampleRate * numChannels * (bitDepth / 8);
            const blockAlign = numChannels * (bitDepth / 8);
            const dataSize = pcmData.length * (bitDepth / 8);
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);
            let offset = 0;
            writeString(view, offset, 'RIFF'); offset += 4;
            view.setUint32(offset, 36 + dataSize, true); offset += 4;
            writeString(view, offset, 'WAVE'); offset += 4;
            writeString(view, offset, 'fmt '); offset += 4;
            view.setUint32(offset, 16, true); offset += 4;
            view.setUint16(offset, 1, true); offset += 2;
            view.setUint16(offset, numChannels, true); offset += 2;
            view.setUint32(offset, sampleRate, true); offset += 4;
            view.setUint32(offset, byteRate, true); offset += 4;
            view.setUint16(offset, blockAlign, true); offset += 2;
            view.setUint16(offset, bitDepth, true); offset += 2;
            writeString(view, offset, 'data'); offset += 4;
            view.setUint32(offset, dataSize, true); offset += 4;
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(offset, pcmData[i], true);
                offset += 2;
            }
            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, s) {
            for (let i = 0; i < s.length; i++) {
                view.setUint8(offset + i, s.charCodeAt(i));
            }
        }

        // --- 核心应用逻辑 (无变化) ---

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        async function speakWord(word, cardId) {
            const card = document.getElementById(cardId);
            const cardContent = card.querySelector(`#content-${cardId}`);
            const loadingIndicator = card.querySelector(`#loading-${cardId}`);
            
            if (audioPlayer && audioPlayer.state === 'running') {
                audioPlayer.stop();
                audioPlayer = null;
                return;
            }

            if (cardContent && loadingIndicator) {
                cardContent.classList.add('hidden');
                loadingIndicator.classList.remove('hidden');
            }

            initAudioContext();

            const payload = {
                contents: [{
                    parts: [{ text: `说: ${word}` }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            let audioUrl = null;
            const maxRetries = 3;
            let delay = 1000;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(TTS_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP xatosi! Holat kodi: ${response.status}`);
                    }

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                        const rateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000;

                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        audioUrl = URL.createObjectURL(wavBlob);
                        
                        const arrayBuffer = await wavBlob.arrayBuffer();
                        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                        
                        if (audioContext.state === 'suspended') {
                            await audioContext.resume();
                        }

                        if (audioPlayer) {
                            audioPlayer.stop();
                        }

                        audioPlayer = audioContext.createBufferSource();
                        audioPlayer.buffer = audioBuffer;
                        audioPlayer.connect(audioContext.destination);
                        
                        audioPlayer.start(0);

                        audioPlayer.onended = () => {
                            audioPlayer = null;
                            if (audioUrl) {
                                URL.revokeObjectURL(audioUrl);
                            }
                        };
                        
                        break; 

                    } else {
                        throw new Error("API javobida audio ma'lumotlari yoki noto'g'ri MIME turi yo'q.");
                    }
                } catch (error) {
                    console.error(`Urinish ${attempt + 1} muvaffaqiyatsiz:`, error.message);
                    if (attempt < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        console.error("Audio ijro etilmadi. Internet aloqasini tekshiring yoki keyinroq urinib ko'ring.");
                    }
                }
            }
            
            if (cardContent && loadingIndicator) {
                loadingIndicator.classList.add('hidden');
                cardContent.classList.remove('hidden');
            }
        }

        function flipCard(cardId) {
            const card = document.getElementById(cardId);
            card.classList.toggle('flipped');
        }

        function flipAllCards() {
            const allCards = document.querySelectorAll('.flashcard');
            const isAnyFlipped = Array.from(allCards).some(card => card.classList.contains('flipped'));
            
            allCards.forEach(card => {
                if (isAnyFlipped) {
                    card.classList.remove('flipped');
                } else {
                    card.classList.add('flipped');
                }
            });
        }

        /**
         * 渲染词汇网格。
         */
        function renderVocabGrid() {
            const vocabGrid = document.getElementById('vocabGrid');
            vocabGrid.innerHTML = vocabList.map((card, index) => {
                const cardId = `flashcard-${index}`;
                // 使用 card-square-wrapper 确保卡片是正方形
                return `
                    <div class="card-square-wrapper">
                        <div id="${cardId}" class="flashcard">
                            <!-- 闪卡正面 (只显示汉字) -->
                            <div class="card-face card-front-style">
                                <!-- SVG 扬声器图标，放在右上角 -->
                                <svg onclick="event.stopPropagation(); speakWord('${card.cn}', '${cardId}')" class="speaker-icon w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M16 4h-2.586l-2.707-2.707A1 1 0 009.293 1H6a1 1 0 00-1 1v2.586L2.707 7.707A1 1 0 002 8.414V19a3 3 0 003 3h14a3 3 0 003-3V5a1 1 0 00-1-1h-4zm-4 13.414L7.586 13H5v-4h2.586L12 4.586V17.414zM16 11H13V9h3v2z"></path>
                                </svg>

                                <div id="loading-${cardId}" class="hidden flex flex-col items-center justify-center absolute inset-0 bg-opacity-70 backdrop-blur-sm rounded-xl">
                                    <div class="loading-ring mb-2"></div>
                                    <p class="text-xs" style="color: #1e3a8a;">Ovoz yuklanmoqda...</p>
                                </div>

                                <div id="content-${cardId}" class="flex flex-col items-center justify-center w-full h-full p-2" onclick="flipCard('${cardId}')">
                                    <!-- 使用 SVG 绘制词汇 -->
                                    <svg viewBox="0 0 450 150" class="word-svg w-full max-w-xs h-auto" fill="currentColor">
                                        <!-- 字体大小调整以适应正方形卡片 -->
                                        <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="70" font-weight="bold">${card.cn}</text>
                                    </svg>
                                </div>
                            </div>

                            <!-- 闪卡背面 (显示拼音和翻译) -->
                            <div class="card-face card-back-style" onclick="flipCard('${cardId}')">
                                <p class="text-3xl sm:text-4xl font-bold mb-2" style="color: #1e3a8a;">${card.py}</p>
                                <hr class="w-1/2 border-t mb-2" style="border-color: #ef4444;">
                                <p class="text-xl sm:text-2xl" style="color: #374151;">${card.uz}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // --- 初始化 ---
        window.onload = function() {
            // 渲染网格
            renderVocabGrid();

            // 尝试初始化 AudioContext
            try {
                initAudioContext();
            } catch (e) {
                console.warn("AudioContext ishga tushirilmadi. Brauzer qo'llab-quvvatlamasligi yoki foydalanuvchi o'zaro aloqasi talab qilinishi mumkin.");
            }
        };

    </script>
</body>
</html>
